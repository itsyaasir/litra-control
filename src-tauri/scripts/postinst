#!/bin/bash

# Post-installation script for Litra Control
# This script sets up udev rules and reloads them

set -e

UDEV_RULES_FILE="/etc/udev/rules.d/99-litra-control.rules"

# Create the udev rules file
cat > "$UDEV_RULES_FILE" << 'EOF'
# Logitech Litra device permissions
# Generated by Litra Control installer

# Logitech Litra Glow (USB)
SUBSYSTEM=="hidraw", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="c900", GROUP="plugdev", MODE="0660"

# Logitech Litra Beam (USB)
SUBSYSTEM=="hidraw", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="c901", GROUP="plugdev", MODE="0660"

# Logitech Litra Beam LX (USB)
SUBSYSTEM=="hidraw", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="b901", GROUP="plugdev", MODE="0660"

# Logitech Litra Beam (newer revision)
SUBSYSTEM=="hidraw", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="c903", GROUP="plugdev", MODE="0660"
EOF

# Reload udev rules
if command -v udevadm >/dev/null 2>&1; then
    udevadm control --reload-rules
    udevadm trigger
fi

# Update desktop database
if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database /usr/share/applications
fi

# Update icon cache
if command -v gtk-update-icon-cache >/dev/null 2>&1; then
    gtk-update-icon-cache -t /usr/share/pixmaps
fi

echo "Litra Control has been installed successfully!"
echo "You may need to log out and log back in for device permissions to take effect."
echo "Alternatively, run: sudo udevadm control --reload-rules && sudo udevadm trigger"